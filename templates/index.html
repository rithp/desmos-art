<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image to Desmos Converter</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>üé® Image to Desmos Converter</h1>
            <p>Convert your images into Desmos polynomial equations</p>
        </header>

        <div class="upload-section">
            <form id="uploadForm" enctype="multipart/form-data">
                <div class="file-input-wrapper" id="dropZone">
                    <input type="file" id="imageInput" name="image" accept="image/*" required>
                    <label for="imageInput" class="file-label">
                        <span id="fileName">Drag & drop an image here or click to choose...</span>
                    </label>
                </div>

                <div class="parameters">
                    <h3>Parameters (Optional)</h3>
                    <p class="params-description">Adjust these settings to fine-tune your conversion</p>
                    
                    <div class="param-grid">
                        <div class="param-group">
                            <label for="rotation">Rotation (degrees):
                                <span class="tooltip">‚ÑπÔ∏è
                                    <span class="tooltiptext">Rotate your image before processing. Use if your image is sideways or upside down.</span>
                                </span>
                            </label>
                            <input type="number" id="rotation" name="rotation" value="0" step="1" min="-360" max="360">
                        </div>

                        <div class="param-group">
                            <label for="segment_size">Polynomial Degree:
                                <span class="tooltip">‚ÑπÔ∏è
                                    <span class="tooltiptext">Higher = smoother curves but more complex. Lower = simpler but less accurate. Try 5-7 for most images.</span>
                                </span>
                            </label>
                            <input type="number" id="segment_size" name="segment_size" value="5" step="1" min="3" max="10">
                        </div>

                        <div class="param-group">
                            <label for="low_threshold">Edge Low Threshold:
                                <span class="tooltip">‚ÑπÔ∏è
                                    <span class="tooltiptext">Minimum brightness change to detect an edge. Lower = more details captured. Try 20-40.</span>
                                </span>
                            </label>
                            <input type="number" id="low_threshold" name="low_threshold" value="30" step="5" min="0" max="200">
                        </div>

                        <div class="param-group">
                            <label for="high_threshold">Edge High Threshold:
                                <span class="tooltip">‚ÑπÔ∏è
                                    <span class="tooltiptext">Maximum brightness change for edges. Higher = only strong edges. Lower = more edges detected. Try 80-120.</span>
                                </span>
                            </label>
                            <input type="number" id="high_threshold" name="high_threshold" value="100" step="5" min="0" max="300">
                        </div>

                        <div class="param-group">
                            <label for="epsilon_factor">Simplification Factor:
                                <span class="tooltip">‚ÑπÔ∏è
                                    <span class="tooltiptext">How much to simplify curves. Higher = fewer points, faster but less detailed. Lower = more accurate. Try 0.0001-0.001.</span>
                                </span>
                            </label>
                            <input type="number" id="epsilon_factor" name="epsilon_factor" value="0.0001" step="0.0001" min="0.0001" max="0.01">
                        </div>

                        <div class="param-group">
                            <label for="min_contour_area">Min Contour Area:
                                <span class="tooltip">‚ÑπÔ∏è
                                    <span class="tooltiptext">Minimum contour size to keep. Lower = more details (including noise). Higher = only large shapes. Try 5-20.</span>
                                </span>
                            </label>
                            <input type="number" id="min_contour_area" name="min_contour_area" value="20" step="1" min="1" max="100">
                        </div>
                    </div>

                    <div class="filter-section">
                        <h3>Blur Filter Settings</h3>
                        
                        <div class="filter-toggle">
                            <label class="checkbox-label">
                                <input type="checkbox" id="use_bilateral" name="use_bilateral">
                                <span>Use Bilateral Filter (edge-preserving)</span>
                            </label>
                            <p class="help-text"> Bilateral filter smooths gradients while preserving edges - better for photos/posters</p>
                        </div>
                        
                        <div id="bilateral-controls" class="filter-controls" style="display: none;">
                            <div class="param-group">
                                <label for="bilateral_d">Neighborhood Diameter:
                                    <span class="tooltip">‚ÑπÔ∏è
                                        <span class="tooltiptext">Pixel neighborhood size. Larger = more blur but slower. Try 5-11.</span>
                                    </span>
                                </label>
                                <input type="range" id="bilateral_d" name="bilateral_d" 
                                       min="5" max="15" value="9" step="2">
                                <span class="value-display" id="bilateral_d_value">9</span>
                            </div>
                            
                            <div class="param-group">
                                <label for="bilateral_sigma_color">Sigma Color (intensity tolerance):
                                    <span class="tooltip">‚ÑπÔ∏è
                                        <span class="tooltiptext">How different pixel intensities can be. Higher = more aggressive smoothing. Try 50-100.</span>
                                    </span>
                                </label>
                                <input type="range" id="bilateral_sigma_color" name="bilateral_sigma_color" 
                                       min="10" max="200" value="75" step="5">
                                <span class="value-display" id="bilateral_sigma_color_value">75</span>
                            </div>
                            
                            <div class="param-group">
                                <label for="bilateral_sigma_space">Sigma Space (spatial reach):
                                    <span class="tooltip">‚ÑπÔ∏è
                                        <span class="tooltiptext">Spatial distance influence. Higher = blur over larger distances. Try 50-100.</span>
                                    </span>
                                </label>
                                <input type="range" id="bilateral_sigma_space" name="bilateral_sigma_space" 
                                       min="10" max="200" value="75" step="5">
                                <span class="value-display" id="bilateral_sigma_space_value">75</span>
                            </div>
                        </div>
                        
                        <div id="gaussian-controls" class="filter-controls">
                            <div class="param-group">
                                <label for="blur_size">Gaussian Blur Size:
                                    <span class="tooltip">‚ÑπÔ∏è
                                        <span class="tooltiptext">Gaussian blur before edge detection. Lower = preserve details. Higher = smooth noise. Odd numbers only (1, 3, 5, 7).</span>
                                    </span>
                                </label>
                                <input type="number" id="blur_size" name="blur_size" value="3" step="2" min="1" max="9">
                            </div>
                        </div>
                    </div>

                    <div class="preprocessing-section">
                        <h3>Advanced Preprocessing</h3>
                        
                        <div class="preprocessing-option">
                            <label class="checkbox-label">
                                <input type="checkbox" id="use_posterize" name="use_posterize">
                                <span>Use Posterization (reduce gradients)</span>
                            </label>
                            <p class="help-text"> Simplifies images by reducing color levels - great for photos/posters with gradients</p>
                            
                            <div id="posterize-controls" class="filter-controls" style="display: none;">
                                <div class="param-group">
                                    <label for="posterize_levels">Posterization Levels:
                                        <span class="tooltip">‚ÑπÔ∏è
                                            <span class="tooltiptext">Number of gray levels (2-16). Lower = more aggressive simplification. Try 4-6 for posters.</span>
                                        </span>
                                    </label>
                                    <input type="range" id="posterize_levels" name="posterize_levels" 
                                           min="2" max="16" value="4" step="1">
                                    <span class="value-display" id="posterize_levels_value">4</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="preprocessing-option">
                            <label class="checkbox-label">
                                <input type="checkbox" id="use_morphology" name="use_morphology">
                                <span>Use Morphological Cleanup (clean edges)</span>
                            </label>
                            <p class="help-text"> Connects broken edges and removes noise - improves contour quality</p>
                            
                            <div id="morphology-controls" class="filter-controls" style="display: none;">
                                <div class="param-group">
                                    <label for="morph_close">Closing Kernel (connect edges):
                                        <span class="tooltip">‚ÑπÔ∏è
                                            <span class="tooltiptext">Larger values connect more distant edges. Try 3-5.</span>
                                        </span>
                                    </label>
                                    <input type="range" id="morph_close" name="morph_close" 
                                           min="2" max="7" value="3" step="1">
                                    <span class="value-display" id="morph_close_value">3</span>
                                </div>
                                
                                <div class="param-group">
                                    <label for="morph_open">Opening Kernel (remove noise):
                                        <span class="tooltip">‚ÑπÔ∏è
                                            <span class="tooltiptext">Larger values remove bigger specks. Try 2-3.</span>
                                        </span>
                                    </label>
                                    <input type="range" id="morph_open" name="morph_open" 
                                           min="1" max="5" value="2" step="1">
                                    <span class="value-display" id="morph_open_value">2</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mode-selector">
                        <label class="mode-option">
                            <input type="radio" name="mode" value="full" checked>
                            <span>Full Conversion (with Desmos equations)</span>
                        </label>
                        <label class="mode-option">
                            <input type="radio" name="mode" value="preview">
                            <span>Preview Contours Only (faster, no equations)</span>
                        </label>
                    </div>
                </div>

                <button type="submit" class="convert-btn" id="convertBtn">
                    <span id="btnText">Convert to Desmos</span>
                    <span id="spinner" class="spinner hidden"></span>
                </button>
            </form>
        </div>

        <div id="results" class="results-section hidden">
            <h2>‚úÖ <span id="resultsTitle">Conversion Complete!</span></h2>
            <p id="statsMessage" class="success-message"></p>
            
            <div class="output-image">
                <h3 id="outputTitle">Output Image</h3>
                <img id="outputImage" src="" alt="Converted image">
                <a id="downloadImage" href="" download class="download-btn">Download Image</a>
            </div>

            <div class="console-output" id="consoleOutputSection">
                <h3>Desmos Console Input</h3>
                <p class="instructions">
                    1. Go to <a href="https://www.desmos.com/calculator" target="_blank">Desmos Calculator</a><br>
                    2. Open browser console (F12 or Ctrl+Shift+I)<br>
                    3. Copy the code below and paste into console<br>
                    4. Press Enter to see your image!
                </p>
                <div class="code-container">
                    <button class="copy-btn" onclick="copyToClipboard()">Copy to Clipboard</button>
                    <pre id="consoleCode"></pre>
                </div>
            </div>

            <div class="download-files">
                <h3>Download Files</h3>
                <a id="downloadDesmos" href="" download class="download-btn">Download Desmos Equations</a>
                <a id="downloadConsole" href="" download class="download-btn">Download Console Script</a>
            </div>
        </div>

        <div id="error" class="error-message hidden"></div>
        
        <div id="loading" class="loading-overlay hidden">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <h3>Processing Your Image...</h3>
                <p id="loadingStatus">Analyzing edges and contours...</p>
            </div>
        </div>
    </div>

    <script>
        const form = document.getElementById('uploadForm');
        const imageInput = document.getElementById('imageInput');
        const fileName = document.getElementById('fileName');
        const convertBtn = document.getElementById('convertBtn');
        const btnText = document.getElementById('btnText');
        const spinner = document.getElementById('spinner');
        const results = document.getElementById('results');
        const error = document.getElementById('error');
        const dropZone = document.getElementById('dropZone');

        // Update file name display
        imageInput.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                fileName.textContent = e.target.files[0].name;
            }
        });

        // Update value displays for range sliders
        document.getElementById('bilateral_d').addEventListener('input', function() {
            document.getElementById('bilateral_d_value').textContent = this.value;
        });

        document.getElementById('bilateral_sigma_color').addEventListener('input', function() {
            document.getElementById('bilateral_sigma_color_value').textContent = this.value;
        });

        document.getElementById('bilateral_sigma_space').addEventListener('input', function() {
            document.getElementById('bilateral_sigma_space_value').textContent = this.value;
        });

        document.getElementById('posterize_levels').addEventListener('input', function() {
            document.getElementById('posterize_levels_value').textContent = this.value;
        });

        document.getElementById('morph_close').addEventListener('input', function() {
            document.getElementById('morph_close_value').textContent = this.value;
        });

        document.getElementById('morph_open').addEventListener('input', function() {
            document.getElementById('morph_open_value').textContent = this.value;
        });

        // Toggle bilateral/Gaussian controls
        document.getElementById('use_bilateral').addEventListener('change', function() {
            const bilateralControls = document.getElementById('bilateral-controls');
            const gaussianControls = document.getElementById('gaussian-controls');
            
            if (this.checked) {
                bilateralControls.style.display = 'block';
                gaussianControls.style.display = 'none';
            } else {
                bilateralControls.style.display = 'none';
                gaussianControls.style.display = 'block';
            }
        });

        // Toggle posterization controls
        document.getElementById('use_posterize').addEventListener('change', function() {
            const posterizeControls = document.getElementById('posterize-controls');
            posterizeControls.style.display = this.checked ? 'block' : 'none';
        });

        // Toggle morphology controls
        document.getElementById('use_morphology').addEventListener('change', function() {
            const morphologyControls = document.getElementById('morphology-controls');
            morphologyControls.style.display = this.checked ? 'block' : 'none';
        });

        // Drag and Drop functionality
        dropZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('drag-over');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                
                // Check if it's an image
                if (file.type.startsWith('image/')) {
                    // Create a new FileList-like object
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    imageInput.files = dataTransfer.files;
                    
                    // Update the file name display
                    fileName.textContent = file.name;
                } else {
                    alert('Please drop an image file (PNG, JPG, GIF, etc.)');
                }
            }
        });

        // Handle form submission
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Show loading overlay
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('loadingStatus').textContent = 'Uploading image...';
            
            // Hide previous results and errors
            results.classList.add('hidden');
            error.classList.add('hidden');

            const formData = new FormData(form);
            
            // Add contours_only flag based on mode selection
            const mode = document.querySelector('input[name="mode"]:checked').value;
            formData.append('contours_only', mode === 'preview' ? 'true' : 'false');
            
            // Remove checkbox values that FormData auto-adds as 'on', then add proper true/false values
            formData.delete('use_bilateral');
            formData.delete('use_posterize');
            formData.delete('use_morphology');
            
            // Add bilateral filter checkbox value
            const useBilateral = document.getElementById('use_bilateral').checked;
            formData.append('use_bilateral', useBilateral ? 'true' : 'false');
            
            // Add posterization checkbox value
            const usePosterize = document.getElementById('use_posterize').checked;
            formData.append('use_posterize', usePosterize ? 'true' : 'false');
            
            // Add morphology checkbox value
            const useMorphology = document.getElementById('use_morphology').checked;
            formData.append('use_morphology', useMorphology ? 'true' : 'false');

            try {
                if (mode === 'preview') {
                    document.getElementById('loadingStatus').textContent = 'Detecting edges and contours...';
                } else {
                    document.getElementById('loadingStatus').textContent = 'Processing image with edge detection...';
                }
                
                const response = await fetch('/convert', {
                    method: 'POST',
                    body: formData
                });

                if (mode === 'full') {
                    document.getElementById('loadingStatus').textContent = 'Generating polynomial equations...';
                }

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                // Display results
                document.getElementById('statsMessage').textContent = data.message || 'Conversion complete!';
                
                // Add timestamp to prevent browser caching
                const timestamp = new Date().getTime();
                document.getElementById('outputImage').src = data.output_image + '?t=' + timestamp;
                document.getElementById('downloadImage').href = data.output_image;
                
                if (data.contours_only) {
                    // Preview mode - hide Desmos sections
                    document.getElementById('resultsTitle').textContent = 'Preview Complete!';
                    document.getElementById('outputTitle').textContent = 'Detected Contours';
                    document.getElementById('consoleOutputSection').classList.add('hidden');
                    document.querySelector('.download-files').classList.add('hidden');
                } else {
                    // Full mode - show all sections
                    document.getElementById('resultsTitle').textContent = 'Conversion Complete!';
                    document.getElementById('outputTitle').textContent = 'Output Image';
                    document.getElementById('consoleOutputSection').classList.remove('hidden');
                    document.querySelector('.download-files').classList.remove('hidden');
                    document.getElementById('consoleCode').textContent = data.console_input;
                    document.getElementById('downloadDesmos').href = data.desmos_file;
                    document.getElementById('downloadConsole').href = data.console_file;
                }
                
                // Hide loading and show results
                document.getElementById('loading').classList.add('hidden');
                results.classList.remove('hidden');
                
                // Scroll to results
                results.scrollIntoView({ behavior: 'smooth' });

            } catch (err) {
                document.getElementById('loading').classList.add('hidden');
                error.textContent = 'Error: ' + err.message;
                error.classList.remove('hidden');
            }
        });

        function copyToClipboard() {
            const code = document.getElementById('consoleCode').textContent;
            navigator.clipboard.writeText(code).then(function() {
                const btn = document.querySelector('.copy-btn');
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            });
        }
    </script>
</body>
</html>
